#!/bin/bash

echo "Cleaning the server ..."
echo

echo 'Waiting for node to be idle'
echo
while ! curl -s -k -X POST https://jenkins.openswitch.net/computer/<%=slave%>/api/xml | grep -q '<idle>true</idle>'; do
    sleep 10;
done

echo "Node is now idle, setting it offline..."
echo
curl -s -X POST -u gerrig:<%=token%> https://jenkins.openswitch.net/computer/<%=slave%>/toggleOffline?offlineMessage="Performing%20daily%20maintenance"

echo 'Waiting for node to be idle again (just in case)'
echo
while ! curl -s -k -X POST https://jenkins.openswitch.net/computer/<%=slave%>/api/xml | grep -q '<idle>true</idle>'; do
    sleep 5;
done

echo 'The node is idle now. Cleaning up the Jenkins Workspace'
echo
find /mnt/jenkins/workspace/ -maxdepth 1 ! -name 'workspace' -type d -exec rm -Rf {} +

echo 'The node is idle now. Cleaning up docker'
sudo docker ps -q |xargs sudo docker rm -f; sudo docker images -q |xargs sudo docker rmi
sudo service docker restart

echo "Setting the node back online.."
# We are seeing that nodes are not being picked up by zuul after they were toogle offline
# as a workaround we will disconnect the node and reconnect it
# Jenkins has an REST API for disconnection, but connection will happen on demand when we fetch the status
curl -s -X POST -u gerrig:<%=token%> https://jenkins.openswitch.net/computer/<%=slave%>/doDisconnect?offlineMessage="Performing%20daily%20maintenance"
curl -s -X POST -u gerrig:<%=token%> https://jenkins.openswitch.net/computer/<%=slave%>/toggleOffline
curl -s https://jenkins.openswitch.net/computer/<%=slave%>/api/json > /dev/null

echo "Cleanup completed"
